function defineValidator(h,f,l){var k={};k.getCursorPosition=function(m){if(m.lengh==0){return -1}return k.getSelectionStart(m)};k.setCursorPosition=function(n,m){if(n.lengh==0){return n}return k.setSelection(n,m,m)};k.getSelectionStart=function(m){if(k.lengh==0){return -1}input=m[0];var o=input.value.length;if(input.createTextRange){var n=document.selection.createRange().duplicate();n.moveEnd("character",input.value.length);if(n.text==""){o=input.value.length}o=input.value.lastIndexOf(n.text)}else{if(typeof(input.selectionStart)!="undefined"){o=input.selectionStart}}return o};k.setSelection=function(n,o,p){if(n.lengh==0){return n}input=n[0];if(input.createTextRange){var m=input.createTextRange();m.collapse(true);m.moveEnd("character",p);m.moveStart("character",o);m.select()}else{if(input.setSelectionRange){input.focus();input.setSelectionRange(o,p)}}return n};k.getElmLoc=function(n){var m={};var o=n;m.left=o.offset().left;m.top=o.offset().top;m.width=o.width()+4;m.height=o.height()+6;return m};k.setTipLoc=function(y,w,s,r,u,n){if(n==null||n==undefined){n={tipDir:null,tipOffset:null}}if(!n.tipDir&&!s){return}var v=k.getElmLoc(y);var t=w[0].offsetWidth;var m=w[0].offsetHeight;var x={};var o=(n.tipOffset&&n.tipOffset.top?n.tipOffset.top:0)+(u?u:0);var q=(n.tipOffset&&n.tipOffset.left?n.tipOffset.left:0)+(r?r:0);var p=s?s:n.tipDir;if(p=="up"){x.top=v.top-m+o;x.left=v.left+q}else{if(p=="left"){x.top=v.top+(v.height-m)/2+o;x.left=v.left-t+q}else{if(p=="down"){x.top=v.top+v.height+o;x.left=v.left+q}else{if(p=="right"){x.top=v.top+(v.height-m)/2+o;x.left=v.left+v.width+q}else{if(p=="none"){return}else{throw new Error("tipDir设置错误！");return}}}}}w.offset(x)};k.getZIndex=function(m){if(m[0].tagName.toLowerCase()=="body"){return 1}var n=m.css("z-index");if(n=="auto"){n=k.getZIndex(m.parent())}return n};var c="";function g(o,n){var m=this;m.options=f.extend({},g.prototype.defaults,n);m.$target=f(o);m.$wrapper=f(m.options.wrapper);m.render()}g.prototype={render:function(){var m=this;m.$target=this.$target;if(!m.$target){return false}m.options.tpl=m.options.defaultTpl;m.count();m.setTrigger("keydown blur paste input")},setTrigger:function(n){var m=this;m.$target=this.$target;m.$target.on(n,function(o){setTimeout(function(){m.count()},110)})},setOptions:function(n){var m=this;m.options=f.extend(m.options,n);m.$wrapper=f(m.options.wrapper)},getlen:function(){var u=this;var s=new RegExp("(^[\\s\\t\\xa0\\u3000]+)|([\\u3000\\xa0\\s\\t]+\x24)","g");var t=function(x){var y=u.options.ignore;if(y){for(var w=0;w<y.length;w++){var v=[];for(j=0;j<x.length;j++){if(x.charAt(j)!==y.charAt(w)){v.push(x.charAt(j))}}x=v.join("")}}return String(x).replace(s,"")};var n=this.$target;var o=t(n.val());var p=u.options.trim;if(p&&typeof(p)=="function"){o=p(o)}var r=u.options.isRejectTag;var m=u.options.isEnToCn;if(r){o=o.replace(/<[^>]*>/g,"")}var q=o.length;o.replace(/[\u0080-\ufff0]/g,function(){q++});if(m){o=o.replace(/[^\x00-\xff]/g,"**");q=Math.ceil(o.length/2)}return q},count:function(){var p=this;p.$target=this.$target;var n=p.getlen();var m=p.options.max;var r=p.options.defaultTpl;var s=p.options.exceedTpl;var q=n>m&&s||r;var o=p.options.isCut;if(o){q=r;p._cutText()}p.options.tpl=q;p._create()},_cutText:function(){var p=this;var o=p.options.isCut;if(!o){return false}var n=p.getlen();var m=p.options.max;$target=this.$target;if(n>m){var q=$target.val();while(p.getlen()>m){q=$target.val();q=q.substr(0,q.length-1);$target.val(q)}}},_create:function(){var q=this,t=this.$wrapper,p=this.$target,r=q.options.tpl,o=q.getlen(),n=q.options.max,s;if(!p.length){return false}function m(w,v,u){return w.replace(u||/\\?\{([^{}]+)\}/g,function(y,x){if(y.charAt(0)==="\\"){return y.slice(1)}return(v[x]===undefined)?c:v[x]})}s=m(r,{len:o,max:n,remain:Math.abs(n-o)});t.html(s)}};g.prototype.defaults={wrapper:"",target:"",el:"",tpl:"",defaultTpl:'<span class="ks-letter-count"><em class="J_LetterRemain">{remain}</em>字节</span>',exceedTpl:'<span class="ks-letter-count-exceed">超出<em class="J_LetterRemain exceed-letter">{remain}</em>字节</span>',max:50,len:0,isRejectTag:false,isEnToCn:false,isCut:false};var a=100;var e={version:"1.0.1",vldOnBlur:false,checkOnError:true,focus1stErr:true,timer:true,errorFiled:null,errorClass:"",errorLocClass:"",errTipTpl:"<div class='errorTip' style='z-index:10;position:absolute;'>{{message}}</div>",tipDir:"right",tipOffset:null,defaultMsg:"输入有误，请重新输入",parent:"body",autoRevise:false};var i=function(m){e=f.extend(true,e,m)};var d=function(m,o){if(!m||!m.length){throw new Error("参数错误");return}var n=this;n.opts=f.extend(true,{},e,o);n.dynamicVlds=[];n.validations=[];f.each(m,function(p,q){n.validations.push(f.extend(true,{},q))});n._init()};d.prototype._init=function(){var s=this;var r=s.opts;var q=s.dynamicVlds;var p=s.validations;r.$errorField=f(r.errorField);r.$parent=f(r.parent);var m=[];for(var o=0;o<p.length;o++){if(f(p[o].field).length>1){var n=[];f.each(f(p[o].field),function(u,v){var t=f.extend(true,{},p[o],{field:f(v),derivedFrom:p[o]});m.push(t);n.push(t)});p[o].children=n}else{m.push(p[o])}}s.originalValidations=p;s.validations=m;p=s.validations;for(var o=0;o<p.length;o++){p[o].passed=true;p[o].checked=false;p[o].$el=f(p[o].field);p[o].$errorLoc=f(p[o].errorLoc);if(p[o].limiter){p[o].textLimiter=new g(p[o].$el,f.extend(true,{},e.limiter,r.limiter,p[o].limiter))}if(p[o].dynamicVld){q.push(p[o])}if(r.vldOnBlur){p[o].$el.on("blur",{vld:p[o]},function(t){s._check(t.data.vld)})}if(!r.autoRevise){s._initPosition(p[o])}}if(r.timer){if(q.length!=0){setInterval(function(){for(var t=0;t<q.length;t++){s._dynamicCheck(q[t]);if(q[t].limiter){q[t].textLimiter.count()}}},a)}if(r.checkOnError){setInterval(function(){for(var t=0;t<p.length;t++){if(p[t].onError){s.validate(p[t])}if(p[t].limiter){p[t].textLimiter.count()}}},a)}}else{for(var o=0;o<p.length;o++){if(p[o].dynamicVld){s._initDynamicVld(p[o])}}}};d.prototype._initDynamicVld=function(n){var m=this;if(f.browser.msie){n.$el.on("keydown",{vld:n},function(o){setTimeout(function(){m._dynamicCheck(o.data.vld)},0)})}else{n.$el.on("input",{vld:n},function(o){setTimeout(function(){m._dynamicCheck(o.data.vld)},0)})}n.$el.on("paste",{vld:n},function(o){setTimeout(function(){m._dynamicCheck(o.data.vld)},0)})};d.prototype._initPosition=function(n){var m=this;if(f.browser.msie){n.$el.on("keydown",{vld:n},function(o){setTimeout(function(){n.oldPosition=k.getCursorPosition(n.$el)},0)})}else{n.$el.on("input",{vld:n},function(o){setTimeout(function(){n.oldPosition=k.getCursorPosition(n.$el)},0)})}};d.prototype._dynamicCheck=function(m){this.validate(m)};d.prototype._check=function(m){if(m.onError){m.onError=false}return this.validate(m)};d.prototype._allChecked=function(){for(var m=0;m<this.validations.length;m++){if(!this.validations[m].checked){return false}}return true};d.prototype.results=function b(n){n=n?n:this.originalValidations;var m=[];f.each(n,function(q,s){if(s.children){var p=b(s.children);var o={field:s.field,passed:true,rules:s.rules,detail:"该field包含多个DOM元素，查看childrenResults",childrenResults:p};for(var r=0;r<p.length;r++){if(!p[r].passed){o.passed=false;break}}}else{var o={field:s.field,passed:s.passed,rules:s.rules,details:s.details}}m.push(o)});return m};d.prototype.isPassed=function(){if(!this._allChecked()){throw new Error("存在未被检验过的input，可手动调用validateAll()以保证全部被检验过");return null}var n=this.results();for(var m=0;m<n.length;m++){if(!n[m].passed){return false}}return true};d.prototype.validateAll=function(){var p=this.validations;var n=true;for(var o=0;o<p.length;o++){var m=this.validate(p[o]);n=m==false?false:n}if(this.opts.focus1stErr&&!n){for(var o=0;o<p.length;o++){if(p[o].passed==false){p[o].$el.focus();return false}}}return n};d.prototype.validate=function(r){var u=this;var m=u.opts;var s=u.dynamicVlds;var q=u.validations;var o=r.msg?r.msg:(m.defaultMsg?m.defaultMsg:"");var y=r.field;var A=r.$errorLoc;var C=r.$el;var x=r.$el[0];var z=x.value;var B;r.checked=true;if(typeof r.rule=="function"){var B=r.rule();if(B){v()}else{t()}return B}if(r.rule.constructor==RegExp){var B=r.rule.test(z);r.rule.lastIndex=0;if(B){v()}else{t()}return B}var w=r.rule;var n=/\[\$\((.+)\)\]/g;if(n.test(w)){w=w.replace(n,function(D,G,E,F){return f(G).val()})}B=l.validate(z,w);r.details=B.details;r.passed=B.passed;r.rules=B.rules;var p=arguments.callee.caller==u._dynamicCheck;if(r.passed==true){v();return{details:r.details,passed:r.passed,rules:r.rules}}else{t();return{details:r.details,passed:r.passed,rules:r.rules}}function v(){r.oldVal=r.$el.val();if(A){A.html("");if(m.errorLocClass){A.removeClass(m.errorLocClass)}else{A.hide()}}if(r.errTipSet){r.errTipSet.remove()}C.removeClass(m.errorClass);u._showInErrorField()}function t(){var G=r.tipOffset&&r.tipOffset.left?r.tipOffset.left:0;var F=r.tipOffset&&r.tipOffset.top?r.tipOffset.top:0;var D=r.tipDir;if(p){if(m.autoRevise){r.$el.val(B.revisedVal);if(u.validate(r)){return}}else{if(B.revisedVal!=z){r.$el.val(r.oldVal);k.setCursorPosition(r.$el,r.oldPosition-1);if(u.validate(r)){return}}else{r.oldVal=z}}return}r.onError=true;if(A){r.$errorLoc.html(o);if(m.errorLocClass){r.$errorLoc.addClass(m.errorLocClass)}else{r.$errorLoc.show()}}C.addClass(m.errorClass);if(m.checkOnError&&!m.timer&&!r.binded){r.binded=true;if(f.browser.msie){C.on("keydown paste",{vld:r},function(H){setTimeout(function(){u.validate(H.data.vld)},0)})}else{C.on("input paste",{vld:r},function(H){setTimeout(function(){u.validate(H.data.vld)},0)})}}if((D&&D!="none")||(m.tipDir&&m.tipDir!="none")){if(r.errTipSet){r.errTipSet.remove()}var E=f(m.errTipTpl.replace("{{message}}",o));m.$parent.append(E);k.setTipLoc(C,E,D,G,F,m);r.errTipSet=E}u._showInErrorField()}};d.prototype.revise=function(m){var n=this;f.each(this.validations,function(o,p){if(m||p.dynamicVld){n._dynamicCheck(p);if(p.textLimiter){p.textLimiter.count()}}});return n.validateAll()};d.prototype.validateOne=function(m){if(m>=this.validations.length){throw new Error("index越界");return}return this.validate(this.validations[m])};d.prototype._showInErrorField=function(){var n=this;var m=[];f.each(n.validations,function(o,q){if(!q.passed){var p=q.msg?q.msg:(n.opts.defaultMsg?n.opts.defaultMsg:"");if(p!=""){m.push(p)}}});n.opts.$errorField.html(m.join("<br/>"))};f.Validator=d;h.Validator=d;h.ValidatorDefaults=i;f.fn.validator=function(m){m.fields=this;var n=new f.Validator([m],m);return this}}if(typeof define=="function"){define("Validator",function(b,a,c){b("jquery");b("VldRulesLib");defineValidator(window,$,VldRulesLib);c.exports=Validator})}else{defineValidator(window,$,VldRulesLib)};