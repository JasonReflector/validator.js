define(function(e,c,g){e("jquery");e("limiter");var b=e("VldRulesLib");var a=100;var h=true;var d={ie:$.browser.msie};$.Validator={};$.Validator.defaults={vldOnclick:null,vldOnBlur:false,vldOnEnter:false,checkOnError:true,timer:true,errorFiled:null,errorClass:"",errorLocClass:"",errTipTpl:"<div class='errorTip' id='{{id}}' style='z-index:{{zindex}};position:absolute;'>{{message}}</div>",tipDir:"right",tipOffset:null,defaultMsg:"输入有误，请重新输入",trigger:null,parent:"body"};$.Validator.validator=function(i,j){this.opts=$.extend({},$.Validator.defaults,j);this.errorMsg={};this.hasRel=false;this.relations={};this._this=this;this.dynamicVlds=[];this.validations=i;if(i.length==0){return true}this.start()};var f=$.Validator.validator;f.prototype.start=function(){var k=this.opts;var o=this.errorMsg;var s=this.relations;var q=this.dynamicVlds;var l=this.validations;var p=this;for(var n=0;n<l.length;n++){if(l[n].field.constructor==jQuery&&l[n].field.length>1){for(var m=0;m<l[n].field.length;m++){var r=$.extend({},l[n]);if(!l[n].field[m].getAttribute("id")){l[n].field[m].setAttribute("id",$.Validator.randomString(10))}r.field=$(l[n].field.selector+"#"+l[n].field[m].getAttribute("id"));l.push(r)}l.shift(n)}}for(var n=0;n<l.length;n++){l[n].passed=true;if(l[n].field.constructor==jQuery){l[n].$el=l[n].field;l[n].randomId=$.Validator.randomString(10)}else{l[n].$el=$("#"+l[n].field);l[n].randomId=$.Validator.randomString(10)}if(!l[n].$el.attr("id")){l[n].$el.attr("id",l[n].randomId)}if(l[n].limiter){l[n].$el.limiter(l[n].limiter)}if(l[n].dynamicVld){q.push(l[n])}}if(k.vldOnclick){$(k.vldOnclick).bind("click",function(){p.validateAll()})}if(k.vldOnBlur||k.vldOnEnter){for(var n=0;n<l.length;n++){if(k.vldOnBlur){$(k.parent).delegate(l[n].$el.selector,"blur",{index:n,field:l[n].field},function(i){p.check(i.data.index)})}if(k.vldOnEnter){$(k.parent).delegate(l[n].$el.selector,"keyup",{index:n,field:l[n].field},function(i){p.onEnterHandler(i)})}}}if(k.trigger){for(var n=0;n<k.trigger.length;n++){$(k.trigger[n].elm).bind(k.trigger[n].event,function(){p.validateAll()})}}if(k.timer){if(q.length!=0){setInterval(function(){for(var j=0;j<q.length;j++){p.dynamicCheck(q[j])}},a)}if(k.checkOnError){setInterval(function(){for(var j=0;j<l.length;j++){if(l[j].onError){if(p.hasRel){p.validateRel(l[j])}else{p.validate(l[j])}}}},a)}}else{for(var n=0;n<l.length;n++){if(l[n].dynamicVld){p.initDynamicVld(l[n])}}}};f.prototype.initDynamicVld=function(i){var j=this;if(d.ie){if(h){$(j.opts.parent).delegate(i.$el.selector,"keydown",{vld:i},function(k){setTimeout(function(){j.dynamicCheck(k.data.vld)},0)})}else{i.$el.on("keydown",{vld:i},function(k){setTimeout(function(){j.dynamicCheck(k.data.vld)},0)})}}else{if(h){$(j.opts.parent).delegate(i.$el.selector,"input",{vld:i},function(k){setTimeout(function(){j.dynamicCheck(k.data.vld)},0)})}else{i.$el.on("input",{vld:i},function(k){setTimeout(function(){j.dynamicCheck(k.data.vld)},0)})}}if(h){$(j.opts.parent).delegate(i.$el.selector,"paste",{vld:i},function(k){setTimeout(function(){j.dynamicCheck(k.data.vld)},0)})}else{i.$el.on("paste",{vld:i},function(k){setTimeout(function(){j.dynamicCheck(k.data.vld)},0)})}};f.prototype.dynamicCheck=function(i){this.validate(i)};f.prototype.check=function(i){if(this.validations[i].onError){this.validations[i].onError=false}if(this.hasRel==false){return this.validate(this.validations[i])}else{return this.validateRel(this.validations[i])}};f.prototype.onEnterHandler=function(i){if(i.keyCode==13){return this.check(i.data.index)}};f.prototype.isPassed=function(){for(var j=0;j<this.validations.length;j++){if(!this.validations[j].passed){return false}}return true};f.prototype.results=function(){return $.map(this.validations,function(j,i){return{field:j.field,passed:j.passed}})};f.prototype.validateAll=function(){var m=this.validations;var k=true;for(var l=0;l<m.length;l++){var j=this.validate(m[l]);k=j==false?false:k}if(!k){for(var l=0;l<m.length;l++){if(m[l].passed==false){$(m[l].$el).focus();return false}}}return k};f.prototype.validateRel=function(i){};f.prototype.validate=function(s){var u=this.opts;var j=this.errorMsg;var n=this.relations;var x=this.dynamicVlds;var k=this.validations;var z=this;var i=s.field;var B=s.randomId;var l=s.msg?s.msg:u.defaultMsg;var m=s.errorLoc;var C=s.$el;var r=s.$el[0];var w=r.value;var p=s.tipOffset&&s.tipOffset.left?s.tipOffset.left:0;var A=s.tipOffset&&s.tipOffset.top?s.tipOffset.top:0;var v=s.tipDir;if(typeof s.rule=="function"){var q=s.rule();if(q){t()}else{y()}return q}if(s.rule.constructor==RegExp){var q=s.rule.test(w);s.rule.lastIndex=0;if(q){t()}else{y()}return q}var o=s.rule;if(o.indexOf("#")!=-1){o=o.replace(/#[a-zA-Z0-9_]+/ig,function(F,D,E){return"0"+$(F)[0].value+""})}if(arguments.callee.caller==z.dynamicCheck){var q=VldRulesLib.validate(w,o,"",l,t,y);if(!q.result){r.value=q.revisedVal}}else{VldRulesLib.validate(w,o,"",l,t,y)}function t(){s.passed=true;if(m){var D=null;if(m.indexOf("#")!=-1){D=$(m)}else{D=$("#"+m)}D.html("");if(u.errorLocClass){D.removeClass(u.errorLocClass)}else{D.hide()}}if(v||u.tipDir){$("#"+B+"_errTip").remove()}j[B]="";C.removeClass(u.errorClass);z.showInErrorField()}function y(){s.passed=false;s.onError=true;if(m){var E=null;if(m.indexOf("#")!=-1){E=$(m)}else{E=$("#"+m)}E.html(l);if(u.errorLocClass){E.addClass(u.errorLocClass)}else{E.show()}}else{j[B]=l}C.addClass(u.errorClass);if(u.checkOnError&&!u.timer&&!s.binded){s.binded=true;if(d.ie){if(h){$(u.parent).delegate(C.selector,"keydown",{vld:s},function(G){setTimeout(function(){z.validate(G.data.vld)},0)})}else{C.on("keydown",{vld:s},function(G){setTimeout(function(){z.validate(G.data.vld)},0)})}}else{if(h){$(u.parent).delegate(C.selector,"input",{vld:s},function(G){setTimeout(function(){z.validate(G.data.vld)},0)})}else{C.on("input",{vld:s},function(G){setTimeout(function(){z.validate(G.data.vld)},0)})}}if(h){$(u.parent).delegate(C.selector,"paste",{vld:s},function(G){setTimeout(function(){z.validate(G.data.vld)},0)})}else{C.on("paste",{vld:s},function(G){setTimeout(function(){z.validate(G.data.vld)},0)})}}if(v||u.tipDir){$("#"+B+"_errTip").remove();var D=$(u.errTipTpl.replace("{{id}}",B+"_errTip").replace("{{zindex}}",$.Validator.getZIndex(C)).replace("{{message}}",l));var F=u.parent?u.parent:"body";$(F).append(D);$.Validator.setTipLoc(C,D,v,p,A,u)}z.showInErrorField()}};f.prototype.showInErrorField=function(){var k=this.errorMsg;var j=this.opts;var l="";for(var i in k){if(k[i]!=""){l+=k[i];l+="<br/>"}}if(j.errorField){$("#"+j.errorField).html(l)}};$.Validator.getElmLoc=function(j){var i={};var k=j;i.left=k.offset().left;i.top=k.offset().top;i.width=k.width()+4;i.height=k.height()+6;return i};$.Validator.setTipLoc=function(u,s,o,n,q,j){if(j==null||j==undefined){j={tipDir:null,tipOffset:null}}if(!j.tipDir&&!o){return}var r=$.Validator.getElmLoc(u);var p=s[0].offsetWidth;var i=s[0].offsetHeight;var t={};var k=(j.tipOffset&&j.tipOffset.top?j.tipOffset.top:0)+(q?q:0);var m=(j.tipOffset&&j.tipOffset.left?j.tipOffset.left:0)+(n?n:0);var l=o?o:j.tipDir;if(l=="up"){t.top=r.top-i+k;t.left=r.left+m}else{if(l=="left"){t.top=r.top+(r.height-i)/2+k;t.left=r.left-p+m}else{if(l=="down"){t.top=r.top+r.height+k;t.left=r.left+m}else{if(l=="right"){t.top=r.top+(r.height-i)/2+k;t.left=r.left+r.width+m}else{console.log("tipDir设置错误！");return}}}}s.offset(t)};$.Validator.getZIndex=function(i){if(i[0].tagName=="BODY"){return 1}var j=i.css("z-index");if(j=="auto"){j=$.Validator.getZIndex(i.parent())}return j};$.Validator.randomString=function(l){var k="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".split("");if(!l){l=Math.floor(Math.random()*k.length)}var m="";for(var j=0;j<l;j++){m+=k[Math.floor(Math.random()*k.length)]}return m};$.fn.validator=function(i){i.field=this;return new $.Validator.validator(i,i)};g.exports=f;window.Validator=f});